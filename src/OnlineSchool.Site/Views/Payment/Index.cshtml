@model OnlineSchool.Contract.Payment.PurchasableItemModel
@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@{
    var publishableKey = Configuration.GetSection("Stripe").GetValue<string>("PublishableKey");
}
<html>
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="~/css/Stripe.css" />
</head>
<body>
    <div class="d-flex justify-content-center">

        <div class="card payment-card" style="width: 18rem;">
            <div class="chart-loading"></div>
            <div class="card-body">
                <form id="payment-form" name="payment-form" method="POST" action="Charge">
                    <input id="id" value="@(Model.ItemId)" type="hidden" />
                    <input id="publishableKey" value="@publishableKey" type="hidden" />
                    <input id="purchasableItemType" value="@(Model.PurchasableItemType)" type="hidden" />
                    <article>
                        <label style="font-weight:bold">@SharedResources.FillPaymentForm  @Model.ItemName @Model.PurchasableItemType.GetDescription() <br /> @SharedResources.Price:@Model.ItemPrice €</label>
                    </article>
                    <label for="card-name">@SharedResources.FullName</label>
                    <div class="input-group mb-2">
                        <div class="input-group-prepend">
                        </div>
                        <input type="text" class="form-control" name="card-name" id="card-name" pattern="[a-zA-Z0-9]+|[a-zA-Z0-9]+\s{1}[a-zA-Z0-9]{1,}|[a-zA-Z0-9]" title="Type Name and Surname" required />
                        <div class="input-group-append">
                        </div>
                    </div>
                    <label for="card-number">@SharedResources.CreditCardNumber</label>
                    <div class="input-group mb-2">
                        <div class="input-group-prepend">
                        </div>
                        <span id="card-number" class="form-control">
                            <!-- Stripe Card Element -->
                        </span>
                        <div class="input-group-append">
                        </div>
                    </div>
                    <label for="card-cvc">@SharedResources.CVCNumber</label>
                    <div class="input-group mb-2">
                        <div class="input-group-prepend">
                        </div>
                        <span id="card-cvc" class="form-control">
                            <!-- Stripe CVC Element -->
                        </span>
                    </div>
                    <label for="card-exp">@SharedResources.Expiration</label>
                    <div class="input-group mb-2">
                        <span id="card-exp" class="form-control">
                            <!-- Stripe Card Expiry Element -->
                        </span>
                        <div class="input-group-append">
                        </div>
                    </div>
                    <button id="payment-submit" class="btn btn-primary mt-1">@SharedResources.SubmitPayment</button>
                </form>
            </div>
        </div>

    </div>
</body>
</html>


@Html.Hidden("ActionName", @Url.Action("Details", Model.PurchasableItemType.ToString(), new { id = Model.ItemId }))
<script src="https://js.stripe.com/v3/"></script>

<script type="text/javascript">

    $(document).ready(function () {
        var stripe = Stripe($("#publishableKey").val());

        var elements = stripe.elements();
        var style = {
            base: {
                'lineHeight': '1.35',
                'fontSize': '1.11rem',
                'color': '#495057',
                'fontFamily': 'apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif'
            }
        };

        var card = elements.create('cardNumber', {
            'placeholder': '',
            'style': style
        });
        card.mount('#card-number');

        var cvc = elements.create('cardCvc', {
            'placeholder': '',
            'style': style
        });
        cvc.mount('#card-cvc');

        var exp = elements.create('cardExpiry', {
            'placeholder': '',
            'style': style
        });
        exp.mount('#card-exp');


        function displayLoading(formName, isLoading) {
            let form = $(`#${formName}`);

            if (form) {
                try {
                    kendo.ui.progress(form, isLoading);
                }
                catch (e) {
                    console.log(e);
                }
            }
        }

        $('#payment-submit').on('click', function (e) {
            var urlAction = $('#ActionName').val();
            e.preventDefault();
            var cardData = {
                name: $('#card-name').val()
            };

            var id = $('#id').val();
            var purchasableItemType = $('#purchasableItemType').val();
            var nameOnCard = document.getElementById('card-name').value;
            var regName = /^[a-zA-Z]+ [a-zA-Z]+$/;

            if (!nameOnCard.match(regName) || nameOnCard.length == 0) {
                ShowError('@ValidationSharedResources.FullName');
                return false;
            }

            stripe.createToken(card, cardData).then(function (result) {

                if (result.error && result.error.message) {
                    //ShowError(result.error.message);
                    if (result.error.code === "incomplete_number")
                        ShowError('@ValidationSharedResources.CardNumber');
                    else if (result.error.code === "incomplete_cvc")
                        ShowError('@ValidationSharedResources.CVC');
                    else if (result.error.code === "incomplete_expiry")
                        ShowError('@ValidationSharedResources.ExpireDate');

                } else {
                    displayLoading("payment-form", true);
                    $.ajax({
                        type: "POST",
                        url: "/Payment/Charge",
                        data: { stripeToken: result.token.id, id: id, purchasableItemType: purchasableItemType },
                        dataType: "json",
                        success: function (result) {
                            ShowSuccess("@SharedResources.PaymentSuccess");
                            displayLoading("payment-form", false);
                            window.location = urlAction;
                        },
                        error: function (req, status, error) {
                            ShowError("@SharedResources.PaymentError");
                            displayLoading("payment-form", false);
                            console.log(error);
                        }
                    });
                }
            });
        });
    });

</script>