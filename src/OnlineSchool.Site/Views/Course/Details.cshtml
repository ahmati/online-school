@model OnlineSchool.Contract.Courses.CourseModel

@{
    var returnUrl = string.IsNullOrEmpty(Context.Request.Path) ? "~/" : $"~{Context.Request.Path.Value}{Context.Request.QueryString}";
    var duration = 0;
    foreach (var session in Model.Sessions)
    {
        duration += (int)(session.EndTime - session.StartTime).TotalHours;
    }

    var isAuthenticated = User.Identity.IsAuthenticated;
    var isStudent = User.IsInRole("Student");

    var nextSessionDate = ViewBag.NextSessionDate;
}

@section Styles {
    <link rel="stylesheet" href="~/css/details.css" />
    <link rel="stylesheet" href="~/css/animations.css" />
}

<div class="section top-image" style="height: 315px;">
    <div class="section align-bottom">
        <div class="container">

            <div class="section" style="height: 200px;"></div>

            <div class="detail-section-50 float-left">
                <strong class="first-font color-white font-size-40"> @ViewBag.TeacherSubject.Subject.Name </strong>
                <div class="section" style="height: 20px;"></div>
                <div class="table float-left p-0 m-0 align-middle">
                    <div class="float-left" width="30">
                        <img class="cell-icon" alt="" src="~/images/Calendar.png" width="30" />
                    </div>
                    <div class="float-left">
                        <h3 class="text-white align-middle margin-left-10 line-height-30">@Model.StartDate.ToString("dd MMM yyyy")</h3>
                    </div>
                    <div class="float-left">
                        <img class="cell-icon margin-left-20 margin-right-10" alt="" src="~/images/Clock.png" width="30" />
                    </div>
                    <div class="float-left">
                        <h3 class="text-white align-middle line-height-30"> @duration @SharedResources.Hours </h3>
                    </div>
                </div>
            </div>

            <div class="detail-section-50 float-left align-right">
                <div class="section" style="height: 34px;"></div>
                <div class="table float-right fit-content-width m-0">
                    @if (Model.Price > 0)
                    {
                        <div class="table-cell align-bottom fit-content-width">
                            <h5 class="color-white size-20 margin-5 float-right fit-content-width">@SharedResources.PerPerson / </h5>
                        </div>
                        <div class="table-cell align-top fit-content-width">
                            <h5 class="color-white size-20 margin-5 fit-content-width"> €</h5>
                        </div>
                        <div class="table-cell align-bottom fit-content-width">
                            <h1 class="color-white height-50 m-0  fit-content-width">@Model.Price</h1>
                        </div>
                    }
                    else
                    {
                        <div class="table-cell align-bottom fit-content-width">
                            <h1 class="color-white height-50 m-0  fit-content-width"> @SharedResources.Free.ToUpper() </h1>
                        </div>
                    }
                </div>
            </div>

        </div>
    </div>
</div>

<div class="section section-grey">
    <div class="container">
        <div class="grid">
            <a class="link" asp-area="" asp-controller="Home" asp-action="Index"> @SharedResources.HomePage </a>
            <img class="next-icon" alt="" src="~/images/next.png" />
            <a class="link" href="#"> @SharedResources.Courses </a>
            <img class="next-icon" alt="" src="~/images/next.png" />
            <a class="link" href="#"> @ViewBag.TeacherSubject.Subject.Name </a>
        </div>
    </div>
</div>

<div class="section">
    <div class="container">
        <div class="left-section float-left">
            <div class="section padding-15 border-box">

                <h1 class="course-name"> @ViewBag.TeacherSubject.Subject.Name </h1>

                <div class="section mt-2">
                    <div class="detail-section-25 table float-left">
                        <div class="table-cell align-middle" style="width: 50px;">
                            <img class="teacher-image-round cell-icon" alt="" src="~/uploads/teachers/@ViewBag.TeacherSubject.Teacher.Id/@ViewBag.TeacherSubject.Teacher.ImagePath" height="40" width="40" />
                        </div>
                        <div class="table-cell align-middle">
                            <p class="cell-caption"> @SharedResources.Teacher </p>
                            <div class="small-height"></div>
                            <h5> @ViewBag.TeacherSubject.Teacher.Name @ViewBag.TeacherSubject.Teacher.Surname </h5>
                        </div>
                    </div>

                    <div class="detail-section-25 table float-left">
                        <div class="table-cell align-middle" style="width: 50px;">
                            <img class="cell-icon" alt="" src="~/images/icon-category-grey.png" width="40" />
                        </div>
                        <div class="table-cell align-middle">
                            <p class="cell-caption">@SharedResources.Category</p>
                            <div class="small-height"></div>
                            <h5> @ViewBag.Category.Name </h5>
                        </div>
                    </div>
                </div>

                <div class="section position-relative my-3">
                    @if (Model.ImagePath != null)
                    {
                        <img class="section" alt="" src="~/uploads/courses/@Model.Id/@Model.ImagePath" />
                    }
                    else
                    {
                        <img class="section" alt="" src="~/images/image4.jpeg" />
                    }
                </div>

                @if (ViewBag.CurrentAvailableSpots == 0)
                {
                    <div class="section">
                        <button disabled class="btn btn-success rounded-0 px-3 float-right">
                            <i class="fas fa-tag"></i> @SharedResources.SoldOut
                        </button>
                    </div>
                }
                else if ((isAuthenticated == false || (isAuthenticated && isStudent)))
                {
                    if (ViewBag.IsBooked)
                    {
                        if (Model.Price > 0)
                        {
                            <div class="section">
                                <button disabled class="btn btn-success rounded-0 px-3 float-right">
                                    <i class="fas fa-shopping-cart"></i> @SharedResources.Bought
                                </button>
                            </div>
                        }
                        else
                        {
                            <div class="section">
                                <button disabled class="btn btn-success rounded-0 px-3 float-right">
                                    <i class="fas fa-handshake"></i> @SharedResources.Joined
                                </button>
                            </div>
                        }
                    }
                    else
                    {
                        if (Model.Price > 0)
                        {
                            <div class="section">
                                <a class="btn my-btn-primary rounded-0 px-3 float-right" asp-controller="Payment" asp-action="Index" asp-route-id="@Model.Id" asp-route-PurchasableItemType="@ViewBag.PurchasableItemType">
                                    <i class="fas fa-shopping-cart"></i> @SharedResources.BuyNow
                                </a>
                            </div>
                        }
                        else
                        {
                            <div class="section">
                                <a class="btn my-btn-primary rounded-0 px-3 float-right" onclick="onJoinCourse(@Model.Id)">
                                    <i class="fas fa-handshake"></i> @SharedResources.Join
                                </a>
                            </div>
                        }
                    }
                }

                <div id="details-section" class="section float-left">
                    @(Html.Kendo().TabStrip()
                    .Name("tabStrip")
                    .SelectedIndex(0)
                    .Animation(animation => animation.Open(open => open.Fade(FadeDirection.In)))
                    .Items(items =>
                    {
                        items.Add().Text(SharedResources.Description)
                            .Selected(true)
                            .Content(@<text>
                                <div>
                                    <p class="my-3"> @ViewBag.TeacherSubject.Subject.Description </p>
                                </div>
                            </text>);

                        items.Add().Text(SharedResources.Program)
                            .Content(@<text>
                                <div>
                                    <div class='section my-3'>
                                        @foreach (var lesson in ViewBag.Lessons) {
                                            <div class='section border-bottom'>
                                                <div class='width-5 float-left'>
                                                    <table>
                                                        <tbody>
                                                            <tr>
                                                                <td class="align-middle">
                                                                    <img alt="" width="20" src="~/images/icon-file-green.png"/>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class='width-95 float-left'>
                                                    <h4 class='padding-7'>@lesson.Name</h4>
                                                </div>
                                                <div class='section' style='height: 10px;'></div>
                                                <p class='section m-0'>@lesson.Description</p>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </text>);

                        items.Add().Text(SharedResources.Teacher)
                            .Content(@<text>
                                <div>
                                    <div class='section my-3'>
                                        <div class='section'>
                                            <div class="table float-left align-middle m-0">
                                                <div class="table-cell align-middle" style="width: 120px;">
                                                    <img class="round-image-100 margin-right-20" alt='' src="~/uploads/teachers/@ViewBag.TeacherSubject.Teacher.Id/@ViewBag.TeacherSubject.Teacher.ImagePath" width="100" height="100"/>
                                                </div>
                                                <div class="table-cell align-middle">
                                                    <h3>
                                                        @ViewBag.TeacherSubject.Teacher.Name @ViewBag.TeacherSubject.Teacher.Surname
                                                    </h3>
                                                    <div class='section mt-3'>
                                                        @if (ViewBag.TeacherSocialNetworks != null && ViewBag.TeacherSocialNetworks.Count > 0)
                                                        {
                                                            var className = "";
                                                            @foreach (var social in ViewBag.TeacherSocialNetworks)
                                                            {
                                                                @if (social.SocialNetworkId == 1)
                                                                {
                                                                    className = "fa-facebook";
                                                                }
                                                                else if (social.SocialNetworkId == 2)
                                                                {
                                                                    className = "fa-linkedin";
                                                                }
                                                                else if (social.SocialNetworkId == 3)
                                                                {
                                                                    className = "fa-twitter";
                                                                }
                                                                <a href="@social.Link" target="_blank" class="fab @className fa-lg mx-2"></a>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <small class="text-muted"> @SharedResources.NoSocialNetworks . </small>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                            <p class='section mt-3'>
                                                @ViewBag.TeacherSubject.Teacher.Description
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </text>);

                        items.Add().Text(SharedResources.Sessions)
                            .Content(@<text>
                                <div>
                                    @{ var i = 1;}
                                    @foreach (var session in ViewBag.Sessions)
                                    {
                                        <div class='section border-bottom p-2'>
                                            <div class="table float-left align-middle m-0">
                                                <div class="table-cell align-middle">

                                                    <h3> @SharedResources.Session @i </h3>

                                                    <div class="font-size-12 my-2 text-right">
                                                        <i class="far fa-clock"></i> @SharedResources.StartTime: @session.StartDate.TimeOfDay -
                                                        <i class="far fa-clock"></i> @SharedResources.EndTime: @session.EndDate.TimeOfDay
                                                    </div>

                                                    <p> @session.Topic </p>
                                                </div>
                                            </div>
                                        </div>

                                        i++;
                                    }
                                </div>
                            </text>);

                        items.Add().Text(SharedResources.Resources)
                            .Content(@<text>
                                <div class='row'>
                                    @{ var resourcesNumber = 0; }

                                    @foreach (var lesson in ViewBag.Lessons)
                                    {
                                        @foreach (var lessonMaterial in lesson.LessonMaterials)
                                        {
                                            resourcesNumber++;

                                            var material = lessonMaterial.Material;

                                            <div class='col-12 border-bottom p-3'>

                                                <i class="far fa-file-alt text-info">
                                                    <small class="text-muted ml-1">
                                                        @material.MimeType.Substring(material.MimeType.IndexOf("/") + 1).ToUpper()
                                                    </small>
                                                </i>


                                                <span class='text-muted ml-3'>
                                                    @material.FileName.Substring(0, material.FileName.IndexOf("."))
                                                </span>

                                                @if (ViewBag.IsBooked)
                                                {
                                                    <a class="btn btn-sm btn-outline-info rounded-0 shadow float-right" target="_blank" href="/TeacherSubject/DownloadLessonMaterial/@lessonMaterial.Id">
                                                        <i class="fas fa-file-download"></i>
                                                        @SharedResources.Download
                                                    </a>
                                                }
                                                else
                                                {
                                                    <a class="btn btn-sm btn-outline-info rounded-0 shadow float-right" asp-controller="Payment" asp-action="Index" asp-route-courseId="@Model.Id">
                                                        <i class="fas fa-download"></i>
                                                        @SharedResources.Download

                                                    </a>
                                                }
                                            </div>
                                        }
                                    }

                                    @foreach (var teacherSubjectMaterial in ViewBag.TeacherSubject.TeacherSubjectMaterials)
                                    {
                                        resourcesNumber++;
                                        var material = teacherSubjectMaterial.Material;

                                        <div class='col-12 border-bottom p-3'>

                                            <i class="far fa-file-alt text-info">
                                                <small class="text-muted ml-1">
                                                    @material.MimeType.Substring(material.MimeType.IndexOf("/") + 1).ToUpper()
                                                </small>
                                            </i>

                                            <span class='text-muted ml-3'>
                                                @material.FileName.Substring(0, material.FileName.IndexOf("."))
                                            </span>

                                            @if (ViewBag.IsBooked)
                                            {
                                                <a class="btn btn-sm btn-outline-info rounded-0 shadow float-right" target="_blank" href="/TeacherSubject/DownloadTeacherSubjectMaterial/@teacherSubjectMaterial.Id">
                                                    <i class="fas fa-download"></i>
                                                    @SharedResources.Download

                                                </a>
                                            }
                                            else
                                            {
                                                <a class="btn btn-sm btn-outline-info rounded-0 shadow float-right" asp-controller="Payment" asp-action="Index" asp-route-courseId="@Model.Id">
                                                    <i class="fas fa-download"></i>
                                                    @SharedResources.Download
                                                </a>
                                            }
                                        </div>
                                    }

                                    @if (resourcesNumber == 0)
                                    {
                                        <p class="my-3"> @SharedResources.NoResourcesUploaded. </p>
                                    }
                                </div>
                            </text>);
                    })
                    .Deferred()
                )
                </div>
            </div>
        </div>

        <div class="right-section float-right">
            <div class="section" style="height: 117px;"></div>

            <div class="section align-middle countdown-border" style="height: 145px;">
                @if (nextSessionDate >= DateTime.Now)
                {
                    <h2 id="headline" class="color-greydark align-top align-text-center padding-top-16">@SharedResources.NextSession:</h2>
                    <div id="countdown" class="color-greydark align-top align-text-center">
                        <ul class="m-0 p-0">
                            <li class="countdown"><span id="days"></span>@SharedResources.Days</li>
                            <li class="countdown"><span id="hours"></span>@SharedResources.Hours</li>
                            <li class="countdown"><span id="minutes"></span>@SharedResources.Minutes</li>
                            <li class="countdown"><span id="seconds"></span>@SharedResources.Seconds</li>
                        </ul>
                    </div>
                    <div id="spinning-dots" class="snippet" style="display: none;">
                        <div class="snippet" data-title=".dot-spin">
                            <div class="stage">
                                <div class="dot-spin"></div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <h2 id="headline" class="color-greydark align-text-center padding-top-60 padding-sides-16">@SharedResources.NoUpcomingSessions.</h2>
                }
            </div>

            <table class="section">
                <tbody>
                    <tr class="table-row">
                        <td class="padding-20">
                            <img style="width: 38px;" alt="" src="~/images/icon-availability.png" />
                        </td>
                        <td class="padding-20">
                            <h4 class="align-right">@ViewBag.CurrentAvailableSpots @SharedResources.RowsAvailable</h4>
                        </td>
                    </tr>
                    <tr class="table-row">
                        <td class="padding-20">
                            <img style="width: 38px;" alt="" src="~/images/icon-clock-grey.png" />
                        </td>
                        <td class="padding-20">
                            <h4 class="align-right">@SharedResources.Duration: @duration @SharedResources.Hours</h4>
                        </td>
                    </tr>
                    <tr class="table-row">
                        <td class="padding-20">
                            <img style="width: 38px;" alt="" src="~/images/icon-pin-grey (1).png" />
                        </td>
                        <td class="padding-20">
                            <h4 class="align-right">@SharedResources.Location: @SharedResources.Remote</h4>
                        </td>
                    </tr>
                    <tr class="table-row">
                        <td class="padding-20">
                            <img style="width: 38px;" alt="" src="~/images/icon-card-grey (1).png" />
                        </td>
                        <td class="padding-20">
                            @if (Model.Price > 0)
                            {
                                <h4 style="text-align: right;">@SharedResources.Price: @Model.Price EURO</h4>
                            }
                            else
                            {
                                <h4 style="text-align: right;">@SharedResources.Price: @SharedResources.Free.ToUpper()</h4>
                            }
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>
</div>

<script>
    $(document).ready(function () {

        let successMsg = '@TempData["Success"]';
        successMsg ? ShowSuccess(successMsg) : null;
        let errorMsg = '@TempData["Error"]';
        errorMsg ? ShowError(errorMsg) : null;

        onJoinCourse = (id) => {
            ShowConfirmation(
                "You are about to join the course. Once joined, you can't unjoin it. Continue?",
                "",
                () => {
                    window.location = `/Course/JoinCourse?id=${id}`;
                },
                null
            );
        }


    });

    let nextSessionDate = new Date("@nextSessionDate.ToString("MM/dd/yyyy hh:mm:ss")");
    if (nextSessionDate >= Date.now()) {
        startCountdown("@nextSessionDate.ToString("MM/dd/yyyy hh:mm:ss")", "@SharedResources.InProgress");
    }

</script>